name: E2E Workflow Tests
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
env:
  E2E_BASE_URL: http://localhost:8080
  E2E_OWNER_EMAIL: ${{ secrets.E2E_OWNER_EMAIL }}
  E2E_OWNER_PASSWORD: ${{ secrets.E2E_OWNER_PASSWORD }}
  E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
  E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}
  E2E_TEACHER_EMAIL: ${{ secrets.E2E_TEACHER_EMAIL }}
  E2E_TEACHER_PASSWORD: ${{ secrets.E2E_TEACHER_PASSWORD }}
  E2E_FINANCE_EMAIL: ${{ secrets.E2E_FINANCE_EMAIL }}
  E2E_FINANCE_PASSWORD: ${{ secrets.E2E_FINANCE_PASSWORD }}
  E2E_PARENT_EMAIL: ${{ secrets.E2E_PARENT_EMAIL }}
  E2E_PARENT_PASSWORD: ${{ secrets.E2E_PARENT_PASSWORD }}
  E2E_PARENT2_EMAIL: ${{ secrets.E2E_PARENT2_EMAIL }}
  E2E_PARENT2_PASSWORD: ${{ secrets.E2E_PARENT2_PASSWORD }}
jobs:
  e2e-workflow-tests:
    name: Workflow E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - name: Create .env.test
        run: |
          {
            echo "E2E_BASE_URL=http://localhost:8080"
            echo "E2E_OWNER_EMAIL=$E2E_OWNER_EMAIL"
            echo "E2E_OWNER_PASSWORD=$E2E_OWNER_PASSWORD"
            echo "E2E_ADMIN_EMAIL=$E2E_ADMIN_EMAIL"
            echo "E2E_ADMIN_PASSWORD=$E2E_ADMIN_PASSWORD"
            echo "E2E_TEACHER_EMAIL=$E2E_TEACHER_EMAIL"
            echo "E2E_TEACHER_PASSWORD=$E2E_TEACHER_PASSWORD"
            echo "E2E_FINANCE_EMAIL=$E2E_FINANCE_EMAIL"
            echo "E2E_FINANCE_PASSWORD=$E2E_FINANCE_PASSWORD"
            echo "E2E_PARENT_EMAIL=$E2E_PARENT_EMAIL"
            echo "E2E_PARENT_PASSWORD=$E2E_PARENT_PASSWORD"
            echo "E2E_PARENT2_EMAIL=$E2E_PARENT2_EMAIL"
            echo "E2E_PARENT2_PASSWORD=$E2E_PARENT2_PASSWORD"
          } > .env.test
      - name: Verify Supabase config exists
        run: |
          if ! grep -q "VITE_SUPABASE_PUBLISHABLE_KEY" .env; then
            echo "::error::Missing VITE_SUPABASE_PUBLISHABLE_KEY in .env â€” the Supabase client will not initialize."
            exit 1
          fi
      - run: npm run dev &
        env:
          CI: true
      - run: npx wait-on http://localhost:8080 --timeout 30000
      - name: Verify app loaded correctly
        run: |
          STATUS=$(curl -s -o /tmp/login-response.html -w "%{http_code}" http://localhost:8080/login)
          if [ "$STATUS" != "200" ]; then
            echo "::error::Expected HTTP 200 from /login but got $STATUS"
            echo "--- Response body ---"
            cat /tmp/login-response.html
            exit 1
          fi
      - name: Smoke test
        id: smoke
        continue-on-error: true
        run: npx playwright test tests/e2e/workflows/smoke-full-system.spec.ts --project=workflow --reporter=list
        env:
          E2E_BASE_URL: http://localhost:8080
      - name: Full workflow suite
        if: steps.smoke.outcome == 'success'
        run: npx playwright test tests/e2e/workflows/ --project=workflow --reporter=html
        env:
          E2E_BASE_URL: http://localhost:8080
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-workflow-report
          path: playwright-report/
          retention-days: 14
      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-screenshots
          path: test-results/
          retention-days: 14
